process {

    withName: METADATA_TO_SAMPLESHEET {
        publishDir = [
            path: "${params.outdir}",
            mode: params.publish_dir_mode
        ]
    }

    withName: 'GRZQC:PREPARE_REFERENCES:(SAMTOOLS_BGZIP|BWAMEM2_INDEX)' {
        publishDir = [
            path: { "${params.reference_path}/${meta.id}" },
            mode: params.publish_dir_mode,
            enabled: "${params.reference_path != null}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: PICARD_ADDORREPLACEREADGROUPS {
        ext.prefix = { "${meta.id}.rrg" }
        ext.args = { [
            "--RGLB library",
            "--RGPL platform",
            "--RGPU barcode",
            "--RGSM ${meta.id}",
            "--TMP_DIR ptmp/"
        ].join(' ').trim() }
    }

    withName: PICARD_MARKDUPLICATES {
        ext.prefix = { "${meta.id}.md" }
        ext.args = { [
            "--CREATE_INDEX",
            "--TMP_DIR ptmp/"
        ].join(' ').trim() }
    }

    withName: MOSDEPTH {
        publishDir = [
            path:"${params.outdir}/mosdepth/",
            pattern: "*{.bed.gz,.summary.txt}",
            mode: params.publish_dir_mode
        ]
    }

    withName: COMPARE_THRESHOLD {
        publishDir = [
            path:"${params.outdir}/compare_threshold/",
            pattern: "*{.csv}",
            mode: params.publish_dir_mode
        ]
    }

    withName: MERGE_REPORTS {
        publishDir = [
            path:"${params.outdir}",
            pattern: "*{.csv,.xlsx}",
            mode: params.publish_dir_mode
        ]
    }

    withName: MULTIQC {
        publishDir = [
            path: { "${params.outdir}/multiqc" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

}
